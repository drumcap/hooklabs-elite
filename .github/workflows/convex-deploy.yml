name: ğŸ—„ï¸ Convex ë°°í¬

on:
  push:
    branches: [main, develop]
    paths: 
      - 'convex/**'
      - 'convex.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging  
        - production

env:
  NODE_VERSION: '20'

jobs:
  # =======================
  # ğŸ” Convex í•¨ìˆ˜ ê²€ì¦
  # =======================
  validate:
    name: ğŸ” Convex í•¨ìˆ˜ ê²€ì¦
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸ” TypeScript íƒ€ì… ê²€ì‚¬
        run: npx convex typecheck
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEV_DEPLOYMENT }}
          
      - name: ğŸ§ª Convex í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
        run: |
          # Convex í•¨ìˆ˜ë³„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          npm run test:convex
        continue-on-error: true
        
      - name: ğŸ“Š í•¨ìˆ˜ í¬ê¸° ë¶„ì„
        run: |
          echo "## Convex í•¨ìˆ˜ í¬ê¸° ë¶„ì„" > convex-analysis.md
          find convex -name "*.ts" -not -path "*/node_modules/*" -not -path "*/_generated/*" | xargs wc -l >> convex-analysis.md

  # =======================  
  # ğŸš€ í™˜ê²½ë³„ ë°°í¬
  # =======================
  deploy:
    name: ğŸš€ Convex ë°°í¬
    runs-on: ubuntu-latest
    needs: [validate]
    
    strategy:
      matrix:
        environment:
          - name: development
            deployment: ${{ secrets.CONVEX_DEV_DEPLOYMENT }}
            deploy_key: ${{ secrets.CONVEX_DEV_DEPLOY_KEY }}
          - name: staging
            deployment: ${{ secrets.CONVEX_STAGING_DEPLOYMENT }}
            deploy_key: ${{ secrets.CONVEX_STAGING_DEPLOY_KEY }}
          - name: production
            deployment: ${{ secrets.CONVEX_PROD_DEPLOYMENT }}  
            deploy_key: ${{ secrets.CONVEX_PROD_DEPLOY_KEY }}
        exclude:
          # ë¸Œëœì¹˜ë³„ í™˜ê²½ ì œí•œ
          - environment: { name: development }
            branch: ${{ github.ref != 'refs/heads/develop' && 'exclude' || '' }}
          - environment: { name: staging }
            branch: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' && 'exclude' || '' }}
          - environment: { name: production }
            branch: ${{ github.ref != 'refs/heads/main' && 'exclude' || '' }}
    
    environment: ${{ matrix.environment.name }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸ—„ï¸ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬
        run: |
          npx convex dev --once --verbose
          echo "ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ í™•ì¸ ì™„ë£Œ"
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
          
      - name: ğŸš€ Convex í•¨ìˆ˜ ë°°í¬
        run: npx convex deploy --cmd 'echo "Convex í•¨ìˆ˜ ë°°í¬ ì™„ë£Œ"'
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
          
      - name: ğŸ§ª ë°°í¬ í›„ health check
        run: |
          # ê¸°ë³¸ í•¨ìˆ˜ë“¤ ë™ì‘ í™•ì¸
          npx convex run --help > /dev/null
          echo "âœ… Convex ë°°í¬ ì™„ë£Œ ë° health check ì„±ê³µ"
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
          
      - name: ğŸ“Š ë°°í¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          echo "## ${{ matrix.environment.name }} ë°°í¬ ë©”íŠ¸ë¦­" > deployment-metrics.md
          echo "- ë°°í¬ ì‹œê°„: $(date)" >> deployment-metrics.md
          echo "- ë¸Œëœì¹˜: ${{ github.ref }}" >> deployment-metrics.md
          echo "- ì»¤ë°‹: ${{ github.sha }}" >> deployment-metrics.md
          echo "- ë°°í¬ í™˜ê²½: ${{ matrix.environment.name }}" >> deployment-metrics.md
          
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (í”„ë¡œë•ì…˜ ë°°í¬)
        if: success() && matrix.environment.name == 'production'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: "ğŸ—„ï¸ Convex í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (ë°°í¬ ì‹¤íŒ¨)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure  
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: "âŒ Convex ${{ matrix.environment.name }} ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."

  # =======================
  # ğŸ”„ ë¡¤ë°± ì¤€ë¹„  
  # =======================
  rollback-prepare:
    name: ğŸ”„ ë¡¤ë°± ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ ë°°í¬ íƒœê·¸ ìƒì„±
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          TAG_NAME="convex-deploy-$(date +'%Y%m%d-%H%M%S')"
          git tag -a $TAG_NAME -m "Convex ë°°í¬: $(date)"
          git push origin $TAG_NAME
          
          echo "ROLLBACK_TAG=$TAG_NAME" >> $GITHUB_ENV
          
      - name: ğŸ“¦ ë°°í¬ ì•„í‹°íŒ©íŠ¸ ë³´ê´€
        uses: actions/upload-artifact@v4
        with:
          name: convex-deployment-${{ github.sha }}
          path: |
            convex/
            convex.json
            package.json
          retention-days: 30