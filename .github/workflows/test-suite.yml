name: ğŸ§ª ì†Œì…œ ë¯¸ë””ì–´ ìë™í™” í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - cron: '0 0 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # í™˜ê²½ ì„¤ì • ë° ê¸°ë³¸ ê²€ì¦
  setup:
    name: ğŸ”§ í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-keys.outputs.cache-key }}
      node-modules-cache-hit: ${{ steps.cache-node-modules.outputs.cache-hit }}
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ìºì‹œ í‚¤ ìƒì„±
        id: cache-keys
        run: |
          echo "cache-key=node-modules-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Node modules ìºì‹œ
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ steps.cache-keys.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: í™˜ê²½ ê²€ì¦
        run: |
          node --version
          npm --version
          echo "âœ… Node.jsì™€ npmì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    
    strategy:
      matrix:
        test-group: [convex, utils]
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node modules ë³µì›
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
        if: needs.setup.outputs.node-modules-cache-hit != 'true'
        run: npm ci

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (${{ matrix.test-group }})
        run: npm run test:unit -- __tests__/unit/${{ matrix.test-group }}

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-${{ matrix.test-group }}
          path: |
            test-results/
            coverage/
          retention-days: 30

  # í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    
    services:
      # Redis (í•„ìš”í•œ ê²½ìš°)
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    env:
      # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜
      NODE_ENV: test
      REDIS_URL: redis://localhost:6379
      CONVEX_DEPLOYMENT: test-deployment
      NEXT_PUBLIC_CONVEX_URL: https://test-convex-url.convex.cloud

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node modules ë³µì›
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
        if: needs.setup.outputs.node-modules-cache-hit != 'true'
        run: npm ci

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:integration

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            coverage/
          retention-days: 30

  # ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
  component-tests:
    name: ğŸ­ ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node modules ë³µì›
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
        if: needs.setup.outputs.node-modules-cache-hit != 'true'
        run: npm ci

      - name: ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:components

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: component-test-results
          path: |
            test-results/
            coverage/
          retention-days: 30

  # E2E í…ŒìŠ¤íŠ¸ (Playwright)
  e2e-tests:
    name: ğŸ¬ E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node modules ë³µì›
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
        if: needs.setup.outputs.node-modules-cache-hit != 'true'
        run: npm ci

      - name: Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: npm run build

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        run: |
          npm start &
          sleep 10
          curl -f http://localhost:3000 || exit 1

      - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (${{ matrix.browser }})
        run: npx playwright test --project=${{ matrix.browser }}

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots-${{ matrix.browser }}
          path: test-results/screenshots/
          retention-days: 7

  # ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ìˆ˜ì§‘ ë° ë¶„ì„
  coverage:
    name: ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, component-tests]
    if: always()
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node modules ë³µì›
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
        if: needs.setup.outputs.node-modules-cache-hit != 'true'
        run: npm ci

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: '*-test-results*'
          path: downloaded-results
          merge-multiple: true

      - name: í†µí•© ì»¤ë²„ë¦¬ì§€ ì‹¤í–‰
        run: npm run test:coverage

      - name: ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦
        run: |
          COVERAGE=$(node -e "
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const avg = Object.values(coverage.total).reduce((sum, metric) => sum + metric.pct, 0) / 4;
              console.log(avg.toFixed(1));
            } catch (e) {
              console.log('0');
            }
          ")
          
          echo "í˜„ì¬ ì»¤ë²„ë¦¬ì§€: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "âœ… ì»¤ë²„ë¦¬ì§€ ëª©í‘œ ë‹¬ì„±! (${COVERAGE}% >= 80%)"
          else
            echo "âŒ ì»¤ë²„ë¦¬ì§€ ëª©í‘œ ë¯¸ë‹¬ (${COVERAGE}% < 80%)"
            exit 1
          fi

      - name: Codecovì— ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    name: âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node modules ë³µì›
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
        if: needs.setup.outputs.node-modules-cache-hit != 'true'
        run: npm ci

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: npm run build

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        run: |
          npm start &
          sleep 10

      - name: Lighthouse CI ì‹¤í–‰
        run: npm run lighthouse
        continue-on-error: true

      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: reports/
          retention-days: 30

  # ë³´ì•ˆ ê²€ì‚¬
  security-audit:
    name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰
        run: npm audit --audit-level high
        continue-on-error: true

      - name: ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ê²€ì‚¬
        run: npm run deps:check
        continue-on-error: true

  # ìµœì¢… ê²°ê³¼ ì§‘ê³„
  test-summary:
    name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, component-tests, e2e-tests, coverage, security-audit]
    if: always()
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: í…ŒìŠ¤íŠ¸ ìš”ì•½ ìƒì„±
        run: |
          echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ê° í…ŒìŠ¤íŠ¸ íƒ€ì…ë³„ ê²°ê³¼ í‘œì‹œ
          echo "### í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ íƒ€ì… | ìƒíƒœ | ë¹„ê³  |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Job ê²°ê³¼ì— ë”°ë¼ ìƒíƒœ í‘œì‹œ
          echo "| ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ | ${{ needs.unit-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | Convex í•¨ìˆ˜, ìœ í‹¸ë¦¬í‹° |" >> $GITHUB_STEP_SUMMARY
          echo "| í†µí•© í…ŒìŠ¤íŠ¸ | ${{ needs.integration-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | API í†µí•©, ë°ì´í„° í”Œë¡œìš° |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ | ${{ needs.component-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | React ì»´í¬ë„ŒíŠ¸ |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E í…ŒìŠ¤íŠ¸ | ${{ needs.e2e-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | ì „ì²´ ì›Œí¬í”Œë¡œìš° |" >> $GITHUB_STEP_SUMMARY
          echo "| ì½”ë“œ ì»¤ë²„ë¦¬ì§€ | ${{ needs.coverage.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | 80% ëª©í‘œ |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ì¶”ê°€ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- ì „ì²´ í…ŒìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸ëŠ” Actions í˜ì´ì§€ì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥" >> $GITHUB_STEP_SUMMARY
          echo "- ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ëŠ” ë³„ë„ ì•„í‹°íŒ©íŠ¸ë¡œ ì œê³µ" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤íŒ¨í•œ E2E í…ŒìŠ¤íŠ¸ì˜ ìŠ¤í¬ë¦°ìƒ· í¬í•¨" >> $GITHUB_STEP_SUMMARY

      - name: ì „ì²´ ê²°ê³¼ íŒì •
        run: |
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
          COMPONENT_STATUS="${{ needs.component-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          COVERAGE_STATUS="${{ needs.coverage.result }}"
          
          echo "=== í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ==="
          echo "ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: $UNIT_STATUS"
          echo "í†µí•© í…ŒìŠ¤íŠ¸: $INTEGRATION_STATUS"  
          echo "ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸: $COMPONENT_STATUS"
          echo "E2E í…ŒìŠ¤íŠ¸: $E2E_STATUS"
          echo "ì»¤ë²„ë¦¬ì§€: $COVERAGE_STATUS"
          
          # í•µì‹¬ í…ŒìŠ¤íŠ¸ë“¤ì´ ëª¨ë‘ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
          if [[ "$UNIT_STATUS" == "success" && "$INTEGRATION_STATUS" == "success" && "$COMPONENT_STATUS" == "success" && "$COVERAGE_STATUS" == "success" ]]; then
            echo "âœ… ëª¨ë“  í•µì‹¬ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"
            exit 0
          else
            echo "âŒ ì¼ë¶€ í•µì‹¬ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

  # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify:
    name: ğŸ“¢ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'schedule')
    
    steps:
      - name: Slack ì•Œë¦¼ ë°œì†¡
        if: env.SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ needs.test-summary.result == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          COLOR="${{ needs.test-summary.result == 'success' && 'good' || 'danger' }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"ì†Œì…œ ë¯¸ë””ì–´ ìë™í™” í…ŒìŠ¤íŠ¸ ê²°ê³¼\",
                \"text\": \"í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì´ $STATUS í–ˆìŠµë‹ˆë‹¤.\",
                \"fields\": [{
                  \"title\": \"ë¸Œëœì¹˜\",
                  \"value\": \"${{ github.ref_name }}\",
                  \"short\": true
                }, {
                  \"title\": \"ì»¤ë°‹\",
                  \"value\": \"${{ github.sha }}\",
                  \"short\": true
                }],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            $SLACK_WEBHOOK_URL