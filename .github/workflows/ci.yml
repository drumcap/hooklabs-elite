name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  CONVEX_DEPLOYMENT: dev:${{ secrets.CONVEX_DEPLOYMENT_NAME }}
  
jobs:
  # =======================
  # ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # =======================
  quality:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸ§¹ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
        run: npm run lint
        
      - name: ğŸ” íƒ€ì… ê²€ì‚¬
        run: npm run type-check
        
      - name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬
        run: npm run security-audit
        
      - name: ğŸ“Š ì˜ì¡´ì„± ê²€ì‚¬
        run: npm run deps:check

  # =======================
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # =======================
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [quality]
    
    strategy:
      matrix:
        test-type: [unit, integration, components]
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸ§ª ${{ matrix.test-type }} í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:${{ matrix.test-type }}
        
      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ (unit í…ŒìŠ¤íŠ¸ë§Œ)
        if: matrix.test-type == 'unit'
        run: npm run test:coverage
        
      - name: ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ì—…ë¡œë“œ
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # =======================
  # ğŸ­ E2E í…ŒìŠ¤íŠ¸
  # =======================
  e2e:
    name: ğŸ­ E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸ­ Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps
        
      - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        run: npm start &
        
      - name: â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ëŒ€ê¸°
        run: npx wait-on http://localhost:3000 --timeout 60000
        
      - name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:e2e
        
      - name: ğŸ“¸ ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/

  # =======================
  # ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
  # =======================
  build-and-deploy:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        environment: 
          - name: development
            branch: develop
            url: https://dev-hooklabs-elite.vercel.app
          - name: production
            branch: main  
            url: https://hooklabs-elite.vercel.app
        exclude:
          - environment: { name: development }
            branch: ${{ github.ref != 'refs/heads/develop' && 'exclude' || '' }}
          - environment: { name: production }
            branch: ${{ github.ref != 'refs/heads/main' && 'exclude' || '' }}
    
    environment:
      name: ${{ matrix.environment.name }}
      url: ${{ matrix.environment.url }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸ—„ï¸ Convex í•¨ìˆ˜ ë°°í¬
        run: npx convex deploy --cmd 'npm run build'
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
          
      - name: ğŸ—ï¸ Next.js ë¹Œë“œ
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_ENV: ${{ matrix.environment.name }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          LEMONSQUEEZY_API_KEY: ${{ secrets.LEMONSQUEEZY_API_KEY }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          
      - name: ğŸ“Š ë²ˆë“¤ ë¶„ì„
        if: matrix.environment.name == 'production'
        run: npm run build:analyze
        
      - name: ğŸ“ˆ Lighthouse ì„±ëŠ¥ ì ìˆ˜
        if: matrix.environment.name == 'production'
        run: |
          npm start &
          sleep 10
          npm run lighthouse
          
      - name: ğŸš€ Vercel ë°°í¬
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ matrix.environment.name == 'production' && '--prod' || '' }}
          working-directory: ./
          
      - name: ğŸ” Health Check
        run: |
          sleep 30
          curl -f ${{ matrix.environment.url }}/api/health
          
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (ì‹¤íŒ¨ì‹œ)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (ì„±ê³µì‹œ)
        if: success() && matrix.environment.name == 'production'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  # =======================
  # ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
  # =======================
  security:
    name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: [quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ” CodeQL ë¶„ì„
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          
      - name: ğŸ”¨ ìë™ ë¹Œë“œ
        uses: github/codeql-action/autobuild@v3
        
      - name: ğŸ“Š CodeQL ë¶„ì„ ì™„ë£Œ
        uses: github/codeql-action/analyze@v3

  # =======================
  # ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  # =======================
  performance:
    name: ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“Š Lighthouse CI ì‹¤í–‰
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
      - name: ğŸ“ˆ Web Vitals ì²´í¬
        run: |
          curl -s "https://hooklabs-elite.vercel.app/api/vitals" | jq '.'