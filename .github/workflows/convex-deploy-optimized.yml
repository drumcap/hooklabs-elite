name: ğŸ—„ï¸ Convex ìµœì í™” ë°°í¬

on:
  push:
    branches: [main, develop]
    paths: 
      - 'convex/**'
      - 'convex.json'
      - 'package.json'
  pull_request:
    branches: [main]
    paths:
      - 'convex/**'
      - 'convex.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging  
          - production
      force_deploy:
        description: 'ê°•ì œ ë°°í¬ (ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë¬´ì‹œ)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  CACHE_VERSION: 'v1'

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (í™˜ê²½ë³„)
concurrency:
  group: ${{ github.workflow }}-${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
  cancel-in-progress: false

jobs:
  # =============================================================================
  # ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„ ë° ì˜í–¥ë„ í‰ê°€
  # =============================================================================
  analyze:
    name: ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„
    runs-on: ubuntu-latest
    outputs:
      schema_changed: ${{ steps.changes.outputs.schema }}
      functions_changed: ${{ steps.changes.outputs.functions }}
      breaking_changes: ${{ steps.breaking.outputs.result }}
      deploy_required: ${{ steps.deploy-check.outputs.required }}
      
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
      
      - name: ğŸ” ë³€ê²½ì‚¬í•­ ê°ì§€
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            schema:
              - 'convex/schema.ts'
              - 'convex/_generated/**'
            functions:
              - 'convex/**/*.ts'
              - '!convex/_generated/**'
              - '!convex/schema.ts'
            config:
              - 'convex.json'
              - 'package.json'
      
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --only=production --prefer-offline
      
      - name: ğŸ” ìŠ¤í‚¤ë§ˆ í˜¸í™˜ì„± ê²€ì‚¬
        id: breaking
        run: |
          if [[ "${{ steps.changes.outputs.schema }}" == "true" ]]; then
            echo "ìŠ¤í‚¤ë§ˆ ë³€ê²½ ê°ì§€ë¨"
            
            # ì´ì „ ìŠ¤í‚¤ë§ˆì™€ í˜¸í™˜ì„± ê²€ì‚¬ (êµ¬ì²´ì  êµ¬í˜„ í•„ìš”)
            if npx convex dev --dry-run 2>&1 | grep -i "breaking\|incompatible"; then
              echo "result=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ í˜¸í™˜ì„±ì´ ê¹¨ì§€ëŠ” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "result=false" >> $GITHUB_OUTPUT
              echo "âœ… í˜¸í™˜ ê°€ëŠ¥í•œ ìŠ¤í‚¤ë§ˆ ë³€ê²½ì…ë‹ˆë‹¤."
            fi
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ìŒ"
          fi
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEV_DEPLOYMENT }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEV_DEPLOY_KEY }}
        continue-on-error: true
      
      - name: ğŸ“Š ë°°í¬ í•„ìš”ì„± íŒë‹¨
        id: deploy-check
        run: |
          if [[ "${{ steps.changes.outputs.schema }}" == "true" || "${{ steps.changes.outputs.functions }}" == "true" || "${{ inputs.force_deploy }}" == "true" ]]; then
            echo "required=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          else
            echo "required=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ë°°í¬í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

  # =============================================================================
  # ğŸ” í•¨ìˆ˜ ê²€ì¦ ë° í…ŒìŠ¤íŠ¸ 
  # =============================================================================
  validate:
    name: ğŸ” Convex í•¨ìˆ˜ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [analyze]
    if: needs.analyze.outputs.deploy_required == 'true'
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-convex-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-convex-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-convex-
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline
      
      - name: ğŸ” TypeScript ì»´íŒŒì¼ ê²€ì‚¬
        run: |
          npx tsc --noEmit --project convex/tsconfig.json
          echo "âœ… TypeScript ì»´íŒŒì¼ ê²€ì¦ ì™„ë£Œ"
      
      - name: ğŸ§ª Convex í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
        run: |
          # Convex íŠ¹ì • í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if npm run test:convex --if-present; then
            echo "âœ… Convex í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ í†µê³¼"
          else
            echo "â„¹ï¸ Convex í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
          fi
      
      - name: ğŸ“Š í•¨ìˆ˜ ë³µì¡ë„ ë¶„ì„
        run: |
          echo "## Convex í•¨ìˆ˜ ë¶„ì„ ë¦¬í¬íŠ¸" > convex-analysis.md
          echo "### í•¨ìˆ˜ í¬ê¸° (ë¼ì¸ ìˆ˜)" >> convex-analysis.md
          find convex -name "*.ts" -not -path "*/_generated/*" | while read file; do
            lines=$(wc -l < "$file")
            echo "- $file: $lines ë¼ì¸" >> convex-analysis.md
            if [ $lines -gt 200 ]; then
              echo "  âš ï¸ ë³µì¡ë„ ë†’ìŒ - ë¦¬íŒ©í† ë§ ê²€í†  í•„ìš”" >> convex-analysis.md
            fi
          done
          
          echo "### ì˜ì¡´ì„± ë¶„ì„" >> convex-analysis.md
          find convex -name "*.ts" -exec grep -l "import.*from" {} \; | wc -l | xargs echo "- ì„í¬íŠ¸ê°€ ìˆëŠ” íŒŒì¼ ìˆ˜:" >> convex-analysis.md
          
          cat convex-analysis.md

  # =============================================================================
  # ğŸ—„ï¸ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ (ë‹¨ê³„ì )
  # =============================================================================
  migrate-schema:
    name: ğŸ—„ï¸ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜
    runs-on: ubuntu-latest
    needs: [analyze, validate]
    if: needs.analyze.outputs.schema_changed == 'true'
    timeout-minutes: 15
    
    strategy:
      matrix:
        environment:
          - name: development
            condition: github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
            deployment: ${{ secrets.CONVEX_DEV_DEPLOYMENT }}
            deploy_key: ${{ secrets.CONVEX_DEV_DEPLOY_KEY }}
          - name: production
            condition: github.ref == 'refs/heads/main'
            deployment: ${{ secrets.CONVEX_PROD_DEPLOYMENT }}
            deploy_key: ${{ secrets.CONVEX_PROD_DEPLOY_KEY }}
        exclude:
          - environment: { name: development }
            condition: ${{ github.ref != 'refs/heads/develop' && github.event_name != 'pull_request' && true || false }}
          - environment: { name: production }
            condition: ${{ github.ref != 'refs/heads/main' && true || false }}
    
    environment: ${{ matrix.environment.name }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-convex-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
      
      - name: âš ï¸ í˜¸í™˜ì„± ê¹¨ëŠ” ë³€ê²½ í™•ì¸
        if: needs.analyze.outputs.breaking_changes == 'true' && matrix.environment.name == 'production'
        run: |
          echo "âŒ í˜¸í™˜ì„±ì´ ê¹¨ì§€ëŠ” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ í”„ë¡œë•ì…˜ì— ë°°í¬ë˜ë ¤ê³  í•©ë‹ˆë‹¤!"
          echo "ìˆ˜ë™ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
          exit 1
      
      - name: ğŸ—„ï¸ ìŠ¤í‚¤ë§ˆ ë°±ì—… (í”„ë¡œë•ì…˜ë§Œ)
        if: matrix.environment.name == 'production'
        run: |
          # í˜„ì¬ ìŠ¤í‚¤ë§ˆ ë°±ì—… (ì‹¤ì œ êµ¬í˜„ ì‹œ Convex CLI ì‚¬ìš©)
          mkdir -p backups
          echo "$(date): ìŠ¤í‚¤ë§ˆ ë°±ì—… ì‹œì‘" > backups/migration-log.txt
          # npx convex export --format=jsonl backups/pre-migration-$(date +%Y%m%d-%H%M%S).jsonl
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
      
      - name: ğŸš€ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        run: |
          echo "ğŸ—„ï¸ ${{ matrix.environment.name }} í™˜ê²½ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘..."
          
          # ì ì§„ì  ë°°í¬ ì „ëµ
          npx convex dev --once --verbose
          
          echo "âœ… ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
      
      - name: ğŸ§ª ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦
        run: |
          echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì¤‘..."
          # ê¸°ë³¸ ì¿¼ë¦¬/ë®¤í…Œì´ì…˜ ë™ì‘ í™•ì¸
          npx convex run --help > /dev/null
          echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì™„ë£Œ"
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}

  # =============================================================================
  # ğŸš€ í•¨ìˆ˜ ë°°í¬ (í™˜ê²½ë³„)
  # =============================================================================
  deploy-functions:
    name: ğŸš€ í•¨ìˆ˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [analyze, validate, migrate-schema]
    if: |
      always() && 
      needs.analyze.outputs.deploy_required == 'true' && 
      (needs.migrate-schema.result == 'success' || needs.migrate-schema.result == 'skipped')
    timeout-minutes: 10
    
    strategy:
      matrix:
        environment:
          - name: development
            condition: github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
            deployment: ${{ secrets.CONVEX_DEV_DEPLOYMENT }}
            deploy_key: ${{ secrets.CONVEX_DEV_DEPLOY_KEY }}
          - name: production
            condition: github.ref == 'refs/heads/main'
            deployment: ${{ secrets.CONVEX_PROD_DEPLOYMENT }}
            deploy_key: ${{ secrets.CONVEX_PROD_DEPLOY_KEY }}
        exclude:
          - environment: { name: development }
            condition: ${{ github.ref != 'refs/heads/develop' && github.event_name != 'pull_request' && true || false }}
          - environment: { name: production }
            condition: ${{ github.ref != 'refs/heads/main' && true || false }}
    
    environment: ${{ matrix.environment.name }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-convex-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
      
      - name: ğŸš€ Convex í•¨ìˆ˜ ë°°í¬
        id: deploy
        run: |
          echo "ğŸš€ ${{ matrix.environment.name }} í™˜ê²½ í•¨ìˆ˜ ë°°í¬ ì‹œì‘..."
          
          # ë°°í¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
          start_time=$(date +%s)
          
          npx convex deploy --cmd 'echo "Convex í•¨ìˆ˜ ë°°í¬ ì™„ë£Œ"'
          
          # ë°°í¬ ì™„ë£Œ ì‹œê°„ ê³„ì‚°
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          echo "duration=$duration" >> $GITHUB_OUTPUT
          echo "âœ… ë°°í¬ ì™„ë£Œ (ì†Œìš”ì‹œê°„: ${duration}ì´ˆ)"
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
      
      - name: ğŸ§ª ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì¤‘..."
          
          # ì£¼ìš” í•¨ìˆ˜ë“¤ ë™ì‘ í™•ì¸
          timeout 30 npx convex run --help || {
            echo "âŒ Convex CLI ì‘ë‹µ ì‹¤íŒ¨"
            exit 1
          }
          
          echo "âœ… ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"
        env:
          CONVEX_DEPLOYMENT: ${{ matrix.environment.deployment }}
          CONVEX_DEPLOY_KEY: ${{ matrix.environment.deploy_key }}
      
      - name: ğŸ“Š ë°°í¬ ë©”íŠ¸ë¦­ ì €ì¥
        run: |
          {
            echo "## ${{ matrix.environment.name }} ë°°í¬ ë¦¬í¬íŠ¸"
            echo "- ë°°í¬ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- ì†Œìš”ì‹œê°„: ${{ steps.deploy.outputs.duration }}ì´ˆ"
            echo "- ë¸Œëœì¹˜: ${{ github.ref_name }}"
            echo "- ì»¤ë°‹: ${{ github.sha }}"
            echo "- íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
            echo "- ìŠ¤í‚¤ë§ˆ ë³€ê²½: ${{ needs.analyze.outputs.schema_changed }}"
            echo "- í•¨ìˆ˜ ë³€ê²½: ${{ needs.analyze.outputs.functions_changed }}"
          } > deployment-report-${{ matrix.environment.name }}.md
          
          cat deployment-report-${{ matrix.environment.name }}.md
      
      - name: ğŸ“„ ë°°í¬ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: convex-deployment-report-${{ matrix.environment.name }}
          path: deployment-report-${{ matrix.environment.name }}.md
          retention-days: 30

  # =============================================================================
  # ğŸ”„ ë¡¤ë°± ì¤€ë¹„ ë° íƒœê¹…
  # =============================================================================
  prepare-rollback:
    name: ğŸ”„ ë¡¤ë°± ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [deploy-functions]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ·ï¸ ë°°í¬ íƒœê·¸ ìƒì„±
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG_NAME="convex-v$(date +'%Y.%m.%d-%H%M%S')"
          git tag -a $TAG_NAME -m "Convex ë°°í¬: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin $TAG_NAME
          
          echo "ROLLBACK_TAG=$TAG_NAME" >> $GITHUB_ENV
          echo "âœ… ë¡¤ë°± íƒœê·¸ ìƒì„±: $TAG_NAME"
      
      - name: ğŸ“¦ ë°°í¬ ìŠ¤ëƒ…ìƒ· ë³´ê´€
        uses: actions/upload-artifact@v4
        with:
          name: convex-snapshot-${{ github.sha }}
          path: |
            convex/
            convex.json
            package.json
            package-lock.json
          retention-days: 90

  # =============================================================================
  # ğŸ“± ì•Œë¦¼ ë° ë¦¬í¬íŒ…
  # =============================================================================
  notify:
    name: ğŸ“± ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [analyze, deploy-functions, prepare-rollback]
    if: always() && needs.analyze.outputs.deploy_required == 'true'
    
    steps:
      - name: ğŸ“¥ ë°°í¬ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
        if: needs.deploy-functions.result == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: convex-deployment-report-*
          merge-multiple: true
      
      - name: ğŸ“± ì„±ê³µ ì•Œë¦¼
        if: needs.deploy-functions.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#convex-deployments'
          fields: repo,message,commit,author,took,workflow
          text: |
            ğŸ—„ï¸ Convex ë°°í¬ ì„±ê³µ!
            
            ğŸ“ í™˜ê²½: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}
            ğŸ”„ ìŠ¤í‚¤ë§ˆ ë³€ê²½: ${{ needs.analyze.outputs.schema_changed == 'true' && 'âœ…' || 'âŒ' }}
            âš¡ í•¨ìˆ˜ ë³€ê²½: ${{ needs.analyze.outputs.functions_changed == 'true' && 'âœ…' || 'âŒ' }}
            
            ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” Actions íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: ğŸ“± ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.deploy-functions.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#convex-deployments'
          fields: repo,message,commit,author,workflow
          text: |
            âŒ Convex ë°°í¬ ì‹¤íŒ¨!
            
            ğŸ“ í™˜ê²½: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}
            ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”.
            
            í•„ìš”ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ì„¸ìš”.
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}