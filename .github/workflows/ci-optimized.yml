name: ğŸš€ ìµœì í™”ëœ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  CACHE_VERSION: 'v2'
  HUSKY: 0
  NEXT_TELEMETRY_DISABLED: 1

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =======================
  # ğŸ“‹ ë³€ê²½ì‚¬í•­ ê°ì§€ ë° ì„¤ì •
  # =======================
  changes:
    name: ğŸ“‹ ë³€ê²½ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.changes.outputs.src }}
      docs: ${{ steps.changes.outputs.docs }}
      deps: ${{ steps.changes.outputs.deps }}
      docker: ${{ steps.changes.outputs.docker }}
      ci: ${{ steps.changes.outputs.ci }}
      
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ” ë³€ê²½ì‚¬í•­ ê°ì§€
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - 'app/**'
              - 'components/**'
              - 'lib/**'
              - 'convex/**'
              - 'public/**'
              - '*.ts'
              - '*.tsx'
              - '*.js'
              - '*.jsx'
            docs:
              - '*.md'
              - 'docs/**'
            deps:
              - 'package*.json'
              - 'pnpm-lock.yaml'
              - 'yarn.lock'
            docker:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - '.dockerignore'
            ci:
              - '.github/workflows/**'

  # =======================
  # ğŸš€ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ìºì‹œ
  # =======================
  setup:
    name: ğŸš€ í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.deps == 'true' || needs.changes.outputs.ci == 'true'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ í™•ì¸
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-node-
            
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          npm ci --prefer-offline --no-audit --progress=false
          
      - name: ğŸ” ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
        if: needs.changes.outputs.deps == 'true'
        run: npm audit --audit-level high --omit=dev

  # =======================
  # ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë³‘ë ¬)
  # =======================
  quality:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ
    runs-on: ubuntu-latest
    needs: [setup, changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        check: [lint, type-check]
        
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ§¹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        run: npm run ${{ matrix.check }}

  # =======================
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë³‘ë ¬)
  # =======================
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [setup, changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true'
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        test-suite: [unit, integration, components]
        
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ§ª ${{ matrix.test-suite }} í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:${{ matrix.test-suite }}
        
      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ (unit í…ŒìŠ¤íŠ¸ë§Œ)
        if: matrix.test-suite == 'unit'
        run: npm run test:coverage
        
      - name: ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        if: matrix.test-suite == 'unit'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          token: ${{ secrets.CODECOV_TOKEN }}

  # =======================
  # ğŸ—ï¸ ë¹Œë“œ ìµœì í™”
  # =======================
  build:
    name: ğŸ—ï¸ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [quality, test, changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true'
    timeout-minutes: 10
    
    strategy:
      matrix:
        environment:
          - name: development
            branch: develop
          - name: production  
            branch: main
        exclude:
          - environment: { name: development }
            branch: ${{ github.ref != 'refs/heads/develop' && 'exclude' || '' }}
          - environment: { name: production }
            branch: ${{ github.ref != 'refs/heads/main' && 'exclude' || '' }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ“¦ Next.js ë¹Œë“œ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ env.CACHE_VERSION }}-${{ matrix.environment.name }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ env.CACHE_VERSION }}-${{ matrix.environment.name }}-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-${{ env.CACHE_VERSION }}-${{ matrix.environment.name }}-
            
      - name: ğŸ—ï¸ Next.js ë¹Œë“œ
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_ENV: ${{ matrix.environment.name }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          
      - name: ğŸ“Š ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.environment.name }}
          path: |
            .next/
            !.next/cache
          retention-days: 1

  # =======================  
  # ğŸ­ E2E í…ŒìŠ¤íŠ¸ (ì¡°ê±´ë¶€)
  # =======================
  e2e:
    name: ğŸ­ E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [build, changes]
    if: github.event_name == 'push' && needs.changes.outputs.src == 'true'
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ—ï¸ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-production
          path: .next/
          
      - name: ğŸ­ Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps chromium
        
      - name: ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        run: npm start &
        
      - name: â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
        run: npx wait-on http://localhost:3000/api/health --timeout 60000
        
      - name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test:e2e
        
      - name: ğŸ“¸ ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¦°ìƒ·
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # =======================
  # ğŸ³ Docker ë¹Œë“œ (ì¡°ê±´ë¶€)
  # =======================
  docker:
    name: ğŸ³ Docker ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [build, changes]
    if: needs.changes.outputs.docker == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ³ Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: ğŸ“Š Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: hooklabs/elite
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_APP_ENV=production
            
  # =======================
  # ğŸ“± ë°°í¬ ì•Œë¦¼
  # =======================
  notify:
    name: ğŸ“± ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build, e2e, docker]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.build.result == 'success' && needs.e2e.result != 'failure' && 'success' || 'failure' }}
          channel: '#ci-cd'
          fields: repo,message,commit,author,action,eventName,ref,workflow
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}