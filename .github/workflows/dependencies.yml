name: ðŸ“¦ ì˜ì¡´ì„± ê´€ë¦¬

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— ì‹¤í–‰
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # =======================
  # ðŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
  # =======================
  security-audit:
    name: ðŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ðŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ðŸ”’ npm audit ì‹¤í–‰
        run: npm audit --audit-level high
        continue-on-error: true
        
      - name: ðŸ› ï¸ ìžë™ ìˆ˜ì • ê°€ëŠ¥í•œ ì·¨ì•½ì  ìˆ˜ì •
        run: npm audit fix
        
      - name: ðŸ“ ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          npm audit --json > security-audit.json
          echo "## ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼" > security-report.md
          echo "$(date)" >> security-report.md
          echo "" >> security-report.md
          
      - name: ðŸ“Š Snyk ë³´ì•ˆ ìŠ¤ìº”
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          
      - name: ðŸ“± ìŠ¬ëž™ ì•Œë¦¼ (ì·¨ì•½ì  ë°œê²¬ì‹œ)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: "ðŸš¨ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."

  # =======================
  # ðŸ“¦ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì²´í¬
  # =======================
  dependency-check:
    name: ðŸ“¦ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì²´í¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ðŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ðŸ” outdated íŒ¨í‚¤ì§€ ê²€ì‚¬
        run: |
          npm outdated --json > outdated.json || true
          cat outdated.json
          
      - name: ðŸ“Š ì˜ì¡´ì„± ë¶„ì„
        run: |
          echo "## ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€" > dependency-report.md
          echo "$(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          npx npm-check-updates --format repo >> dependency-report.md
          
      - name: ðŸ”„ ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ ìƒì„±
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # ë§ˆì´ë„ˆ ë²„ì „ ì—…ë°ì´íŠ¸ë§Œ ìˆ˜í–‰
          npx npm-check-updates --target minor -u
          
          if git diff --quiet package.json; then
            echo "ì—…ë°ì´íŠ¸í•  ë§ˆì´ë„ˆ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            npm install
            git add package.json package-lock.json
            git commit -m "chore: ë§ˆì´ë„ˆ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ (ìžë™)"
            git push origin main
          fi

  # =======================  
  # ðŸ§¹ ì •ë¦¬ ìž‘ì—…
  # =======================
  cleanup:
    name: ðŸ§¹ ì˜ì¡´ì„± ì •ë¦¬
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check]
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ðŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ðŸ§¹ ë¯¸ì‚¬ìš© ì˜ì¡´ì„± ê²€ì‚¬
        run: |
          npm install -g depcheck
          depcheck --json > unused-dependencies.json
          
      - name: ðŸ“Š ë²ˆë“¤ í¬ê¸° ë¶„ì„
        run: |
          npm run build
          npm run build:analyze
          
      - name: ðŸ“ˆ ì˜ì¡´ì„± íŠ¸ë¦¬ ë¶„ì„
        run: |
          npm ls --depth=0 > dependency-tree.txt
          du -sh node_modules > bundle-size.txt
          
      - name: ðŸ“ ì •ë¦¬ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "## ì˜ì¡´ì„± ì •ë¦¬ ë¦¬í¬íŠ¸" > cleanup-report.md
          echo "$(date)" >> cleanup-report.md
          echo "" >> cleanup-report.md
          echo "### ë²ˆë“¤ í¬ê¸°" >> cleanup-report.md
          cat bundle-size.txt >> cleanup-report.md
          echo "" >> cleanup-report.md
          echo "### ì˜ì¡´ì„± íŠ¸ë¦¬" >> cleanup-report.md
          head -20 dependency-tree.txt >> cleanup-report.md