name: ğŸš€ Vercel ìµœì í™” ë°°í¬

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬ ìµœì í™”
  # =============================================================================
  deploy:
    name: ğŸš€ ë°°í¬
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        environment:
          - name: preview
            condition: github.event_name == 'pull_request'
            vercel_env: preview
          - name: development
            condition: github.ref == 'refs/heads/develop'
            vercel_env: development
          - name: production
            condition: github.ref == 'refs/heads/main'
            vercel_env: production
        exclude:
          - environment: { name: preview }
            condition: ${{ github.event_name != 'pull_request' && true || false }}
          - environment: { name: development }
            condition: ${{ github.ref != 'refs/heads/develop' && true || false }}
          - environment: { name: production }
            condition: ${{ github.ref != 'refs/heads/main' && true || false }}
    
    environment:
      name: ${{ matrix.environment.name }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ”§ Vercel CLI ì„¤ì¹˜
        run: npm i -g vercel@latest
      
      - name: ğŸ”— Vercel í”„ë¡œì íŠ¸ ì—°ê²°
        run: vercel pull --yes --environment=${{ matrix.environment.vercel_env }} --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: ğŸ—ï¸ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ìƒì„±
        run: vercel build ${{ matrix.environment.name == 'production' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
      
      - name: ğŸš€ Vercel ë°°í¬
        id: deploy
        run: |
          url=$(vercel deploy ${{ matrix.environment.name == 'production' && '--prod' || '' }} --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "deployment-url=$url" >> $GITHUB_ENV
      
      - name: ğŸ“ ë°°í¬ URL ì €ì¥
        run: |
          echo "ë°°í¬ URL: ${{ steps.deploy.outputs.url }}"
          echo "${{ steps.deploy.outputs.url }}" > deployment-url.txt
      
      - name: ğŸ“¤ ë°°í¬ URL ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: deployment-url-${{ matrix.environment.name }}
          path: deployment-url.txt

  # =============================================================================
  # ğŸ§ª ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
  # =============================================================================
  post-deploy-tests:
    name: ğŸ§ª ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    
    strategy:
      matrix:
        test-type:
          - name: health-check
            description: "í—¬ìŠ¤ì²´í¬"
          - name: performance
            description: "ì„±ëŠ¥ í…ŒìŠ¤íŠ¸" 
          - name: security
            description: "ë³´ì•ˆ í…ŒìŠ¤íŠ¸"
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ ë°°í¬ URL ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: deployment-url-${{ github.ref == 'refs/heads/main' && 'production' || (github.ref == 'refs/heads/develop' && 'development' || 'preview') }}
      
      - name: ğŸ“– ë°°í¬ URL ì½ê¸°
        id: url
        run: |
          URL=$(cat deployment-url.txt)
          echo "deployment-url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"
      
      - name: â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        run: |
          for i in {1..30}; do
            if curl -f -s "${{ steps.url.outputs.deployment-url }}/api/health" > /dev/null; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤"
              exit 0
            fi
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 10
          done
          echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ íƒ€ì„ì•„ì›ƒ"
          exit 1
      
      - name: ğŸ” í—¬ìŠ¤ì²´í¬
        if: matrix.test-type.name == 'health-check'
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.url.outputs.deployment-url }}/api/health")
          if [ $response -eq 200 ]; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼"
          else
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $response)"
            exit 1
          fi
      
      - name: ğŸ“Š Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        if: matrix.test-type.name == 'performance'
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: ${{ steps.url.outputs.deployment-url }}
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: ğŸ”’ ë³´ì•ˆ í…ŒìŠ¤íŠ¸
        if: matrix.test-type.name == 'security'
        run: |
          # HTTPS ë¦¬ë””ë ‰ì…˜ í™•ì¸
          response=$(curl -s -o /dev/null -w "%{http_code}" -L "http://$(echo ${{ steps.url.outputs.deployment-url }} | cut -d'/' -f3)")
          if [ $response -eq 200 ] || [ $response -eq 301 ] || [ $response -eq 302 ]; then
            echo "âœ… HTTPS ë¦¬ë””ë ‰ì…˜ ì •ìƒ"
          else
            echo "âŒ HTTPS ë¦¬ë””ë ‰ì…˜ í™•ì¸ í•„ìš”"
          fi
          
          # ë³´ì•ˆ í—¤ë” í™•ì¸
          curl -I "${{ steps.url.outputs.deployment-url }}" | grep -E "(X-Frame-Options|X-XSS-Protection|X-Content-Type-Options)" || echo "âš ï¸ ì¼ë¶€ ë³´ì•ˆ í—¤ë” ëˆ„ë½"

  # =============================================================================
  # ğŸ“± ì•Œë¦¼ ë° ë³´ê³ 
  # =============================================================================
  notify:
    name: ğŸ“± ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [deploy, post-deploy-tests]
    if: always()
    
    steps:
      - name: ğŸ“¥ ë°°í¬ URL ë‹¤ìš´ë¡œë“œ
        if: needs.deploy.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: deployment-url-${{ github.ref == 'refs/heads/main' && 'production' || (github.ref == 'refs/heads/develop' && 'development' || 'preview') }}
      
      - name: ğŸ“– ë°°í¬ URL ì½ê¸°
        id: url
        if: needs.deploy.result == 'success'
        run: |
          URL=$(cat deployment-url.txt || echo "URL not found")
          echo "deployment-url=$URL" >> $GITHUB_OUTPUT
      
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (ì„±ê³µ)
        if: needs.deploy.result == 'success' && needs.post-deploy-tests.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          fields: repo,message,commit,author,took,workflow
          text: |
            ğŸš€ ë°°í¬ ì„±ê³µ!
            
            ğŸ“ í™˜ê²½: ${{ github.ref == 'refs/heads/main' && 'Production' || (github.ref == 'refs/heads/develop' && 'Development' || 'Preview') }}
            ğŸ”— URL: ${{ steps.url.outputs.deployment-url }}
            âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (ì‹¤íŒ¨)
        if: needs.deploy.result == 'failure' || needs.post-deploy-tests.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          fields: repo,message,commit,author,workflow
          text: |
            âŒ ë°°í¬ ì‹¤íŒ¨!
            
            ğŸ“ í™˜ê²½: ${{ github.ref == 'refs/heads/main' && 'Production' || (github.ref == 'refs/heads/develop' && 'Development' || 'Preview') }}
            ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}