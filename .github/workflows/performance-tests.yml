name: ğŸš€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìë™í™”

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 6ì‹œ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸ ìœ í˜•'
        required: true
        type: choice
        options:
          - all
          - load
          - lighthouse
          - e2e
          - regression
        default: 'all'
      intensity:
        description: 'í…ŒìŠ¤íŠ¸ ê°•ë„'
        required: true
        type: choice
        options:
          - light
          - normal
          - heavy
        default: 'normal'

env:
  NODE_VERSION: '20'
  PERFORMANCE_BASELINE_DAYS: 7

jobs:
  # =======================
  # ğŸ—ï¸ ë¹Œë“œ ë° ì¤€ë¹„
  # =======================
  setup:
    name: ğŸ—ï¸ ë¹Œë“œ ë° í™˜ê²½ ì¤€ë¹„
    runs-on: ubuntu-latest
    outputs:
      should-run-performance: ${{ steps.check.outputs.should-run }}
      test-type: ${{ steps.config.outputs.test-type }}
      intensity: ${{ steps.config.outputs.intensity }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„)

      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ” ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PRì—ì„œëŠ” ë³€ê²½ëœ íŒŒì¼ì„ í™•ì¸í•˜ì—¬ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
            git fetch origin ${{ github.base_ref }}
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|css|json)$|package\.json|next\.config\.js'; then
              echo "should-run=true" >> $GITHUB_OUTPUT
            else
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi

      - name: âš™ï¸ í…ŒìŠ¤íŠ¸ ì„¤ì • êµ¬ì„±
        id: config
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type || 'all' }}"
          INTENSITY="${{ github.event.inputs.intensity || 'normal' }}"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TEST_TYPE="lighthouse"  # PRì—ì„œëŠ” Lighthouseë§Œ ì‹¤í–‰
            INTENSITY="light"       # ê°€ë²¼ìš´ í…ŒìŠ¤íŠ¸
          fi
          
          echo "test-type=$TEST_TYPE" >> $GITHUB_OUTPUT
          echo "intensity=$INTENSITY" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        if: steps.check.outputs.should-run == 'true'
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: steps.check.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            package.json
            next.config.js
          retention-days: 1

  # =======================
  # ğŸ“¡ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # =======================
  api-performance:
    name: ğŸ“¡ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-performance == 'true' && (needs.setup.outputs.test-type == 'all' || needs.setup.outputs.test-type == 'load')
    
    services:
      # API í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤
      app:
        image: node:20-alpine
        options: --name app-service
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        run: |
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸ“Š API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run test tests/performance/api-performance.test.ts
        env:
          TEST_BASE_URL: http://localhost:3000
          PERFORMANCE_INTENSITY: ${{ needs.setup.outputs.intensity }}

      - name: ğŸ“ˆ k6 ë¡œë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        if: needs.setup.outputs.intensity != 'light'
        run: |
          # k6 ì„¤ì¹˜
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          
          # ê°•ë„ë³„ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if [[ "${{ needs.setup.outputs.intensity }}" == "heavy" ]]; then
            export K6_OPTIONS='{"stages":[{"duration":"5m","target":200},{"duration":"10m","target":500}]}'
          else
            export K6_OPTIONS='{"stages":[{"duration":"2m","target":50},{"duration":"5m","target":100}]}'
          fi
          
          k6 run tests/performance/load-test.js
          k6 run tests/performance/api-test.js

      - name: ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          mkdir -p reports/performance
          node -e "
          const metrics = {
            timestamp: new Date().toISOString(),
            commit: '${{ github.sha }}',
            branch: '${{ github.ref_name }}',
            pr: '${{ github.event.number }}',
            intensity: '${{ needs.setup.outputs.intensity }}'
          };
          require('fs').writeFileSync('reports/performance/api-metrics.json', JSON.stringify(metrics, null, 2));
          "

      - name: ğŸ“¤ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: api-performance-report
          path: reports/performance/
          retention-days: 30

      - name: ğŸ›‘ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi

  # =======================
  # ğŸš¦ Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # =======================
  lighthouse-performance:
    name: ğŸš¦ Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-performance == 'true' && (needs.setup.outputs.test-type == 'all' || needs.setup.outputs.test-type == 'lighthouse')
    
    strategy:
      matrix:
        profile: [desktop, mobile]
        include:
          - profile: desktop
            device: 'Desktop Chrome'
          - profile: mobile
            device: 'Pixel 5'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        run: |
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸš¦ Lighthouse CI ì‹¤í–‰ (${{ matrix.profile }})
        run: |
          # Lighthouse CI ì„¤ì • íŒŒì¼ ìƒì„±
          cat > lighthouserc.${{ matrix.profile }}.js << 'EOF'
          module.exports = {
            ci: {
              collect: {
                url: ['http://localhost:3000/', 'http://localhost:3000/dashboard'],
                numberOfRuns: ${{ needs.setup.outputs.intensity == 'light' && '1' || '3' }},
                settings: {
                  preset: '${{ matrix.profile }}',
                  onlyCategories: ['performance', 'accessibility', 'best-practices'],
                  skipAudits: ${{ needs.setup.outputs.intensity == 'light' && '["screenshot-thumbnails", "final-screenshot"]' || '[]' }},
                },
              },
              assert: {
                assertions: {
                  'categories:performance': ['error', { minScore: ${{ matrix.profile == 'mobile' && '0.8' || '0.85' }} }],
                  'categories:accessibility': ['warn', { minScore: 0.9 }],
                  'categories:best-practices': ['warn', { minScore: 0.85 }],
                },
              },
              upload: {
                target: 'filesystem',
                outputDir: './reports/lighthouse/${{ matrix.profile }}',
              },
            },
          };
          EOF
          
          # Lighthouse CI ì‹¤í–‰
          npx @lhci/cli@0.15.x autorun --config=lighthouserc.${{ matrix.profile }}.js

      - name: ğŸ“Š ì„±ëŠ¥ ì ìˆ˜ ì¶”ì¶œ
        run: |
          mkdir -p reports/performance
          node scripts/lighthouse-performance.js --profile ${{ matrix.profile }}

      - name: ğŸ“¤ Lighthouse ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report-${{ matrix.profile }}
          path: reports/lighthouse/
          retention-days: 30

      - name: ğŸ’¬ PR ì½”ë©˜íŠ¸ ì‘ì„± (Lighthouse ê²°ê³¼)
        if: github.event_name == 'pull_request' && matrix.profile == 'desktop'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportFile = fs.readdirSync('./reports/lighthouse/desktop')
                .find(file => file.startsWith('performance-report') && file.endsWith('.json'));
              
              if (reportFile) {
                const report = JSON.parse(fs.readFileSync(path.join('./reports/lighthouse/desktop', reportFile), 'utf8'));
                
                const comment = `## ğŸš¦ Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            
            **Desktop ì„±ëŠ¥ ì ìˆ˜:**
            - ì„±ëŠ¥: ${report.results?.default?.scores?.performance || 'N/A'}ì 
            - ì ‘ê·¼ì„±: ${report.results?.default?.scores?.accessibility || 'N/A'}ì   
            - ëª¨ë²” ì‚¬ë¡€: ${report.results?.default?.scores?.bestPractices || 'N/A'}ì 
            
            **Core Web Vitals:**
            - FCP: ${Math.round(report.results?.default?.vitals?.['first-contentful-paint'] || 0)}ms
            - LCP: ${Math.round(report.results?.default?.vitals?.['largest-contentful-paint'] || 0)}ms
            - CLS: ${report.results?.default?.vitals?.['cumulative-layout-shift']?.toFixed(3) || 'N/A'}
            
            ${report.summary || ''}
            
            <details>
            <summary>ìƒì„¸ ê¶Œì¥ì‚¬í•­</summary>
            
            ${(report.recommendations || []).map(rec => `- ${rec}`).join('\\n')}
            </details>`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('PR ì½”ë©˜íŠ¸ ì‘ì„± ì‹¤íŒ¨:', error.message);
            }

      - name: ğŸ›‘ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi

  # =======================
  # ğŸ­ E2E ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # =======================
  e2e-performance:
    name: ğŸ­ E2E ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-performance == 'true' && (needs.setup.outputs.test-type == 'all' || needs.setup.outputs.test-type == 'e2e')
    
    strategy:
      matrix:
        browser: [chromium, firefox]
        include:
          - browser: chromium
            device: Desktop Chrome
          - browser: firefox
            device: Desktop Firefox
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸ­ Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        run: |
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸ­ E2E ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          # ë¸Œë¼ìš°ì €ë³„ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          npx playwright test tests/performance/e2e-performance.spec.ts --project=${{ matrix.browser }} --reporter=json > test-results-${{ matrix.browser }}.json
        env:
          PERFORMANCE_TEST_MODE: true
          BROWSER: ${{ matrix.browser }}

      - name: ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          mkdir -p reports/performance
          node -e "
          const results = JSON.parse(require('fs').readFileSync('test-results-${{ matrix.browser }}.json', 'utf8'));
          const metrics = {
            timestamp: new Date().toISOString(),
            browser: '${{ matrix.browser }}',
            commit: '${{ github.sha }}',
            results: results
          };
          require('fs').writeFileSync('reports/performance/e2e-${{ matrix.browser }}-metrics.json', JSON.stringify(metrics, null, 2));
          "

      - name: ğŸ“¤ E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-performance-${{ matrix.browser }}
          path: |
            reports/performance/
            test-results/
          retention-days: 30

      - name: ğŸ›‘ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi

  # =======================
  # ğŸ“Š ì„±ëŠ¥ íšŒê·€ ë¶„ì„
  # =======================
  performance-regression:
    name: ğŸ“Š ì„±ëŠ¥ íšŒê·€ ë¶„ì„
    runs-on: ubuntu-latest
    needs: [setup, api-performance, lighthouse-performance, e2e-performance]
    if: always() && needs.setup.outputs.should-run-performance == 'true' && (needs.setup.outputs.test-type == 'all' || needs.setup.outputs.test-type == 'regression')
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ“¥ ëª¨ë“  ì„±ëŠ¥ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: downloaded-reports/

      - name: ğŸ“Š ì„±ëŠ¥ ë¦¬í¬íŠ¸ í†µí•©
        run: |
          mkdir -p reports/performance
          
          # ê° ì•„í‹°íŒ©íŠ¸ì—ì„œ ë¦¬í¬íŠ¸ íŒŒì¼ í†µí•©
          find downloaded-reports/ -name "*.json" -type f | while read file; do
            filename=$(basename "$file")
            cp "$file" "reports/performance/${filename}"
          done
          
          # ë¦¬í¬íŠ¸ ëª©ë¡ ì¶œë ¥
          ls -la reports/performance/

      - name: ğŸ” ì„±ëŠ¥ ê¸°ì¤€ì„  ë‹¤ìš´ë¡œë“œ (ìºì‹œì—ì„œ)
        id: cache-baseline
        uses: actions/cache@v4
        with:
          path: reports/performance/baseline.json
          key: performance-baseline-${{ github.ref_name }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            performance-baseline-${{ github.ref_name }}-
            performance-baseline-main-

      - name: ğŸ” ì„±ëŠ¥ íšŒê·€ ë¶„ì„ ì‹¤í–‰
        run: node scripts/performance-regression.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}

      - name: ğŸ“Š íšŒê·€ ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: regression-analysis
          path: reports/performance/regression-report-*.html
          retention-days: 30

      - name: ğŸ’¾ ì„±ëŠ¥ ê¸°ì¤€ì„  ì—…ë°ì´íŠ¸ (main ë¸Œëœì¹˜)
        if: github.ref == 'refs/heads/main'
        run: |
          # ìƒˆë¡œìš´ ê¸°ì¤€ì„  ì„¤ì •
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          // í˜„ì¬ ì„±ëŠ¥ ë°ì´í„°ë¥¼ ê¸°ì¤€ì„ ìœ¼ë¡œ ì €ì¥
          const baseline = {
            timestamp: new Date().toISOString(),
            commit: '${{ github.sha }}',
            branch: '${{ github.ref_name }}',
            // ì—¬ê¸°ì— ì‹¤ì œ ì„±ëŠ¥ ë°ì´í„° ì¶”ê°€ ë¡œì§ í•„ìš”
          };
          
          fs.writeFileSync('reports/performance/baseline.json', JSON.stringify(baseline, null, 2));
          console.log('ìƒˆë¡œìš´ ì„±ëŠ¥ ê¸°ì¤€ì„  ì €ì¥ ì™„ë£Œ');
          "

  # =======================
  # ğŸ“ˆ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
  # =======================
  performance-report:
    name: ğŸ“ˆ ì¢…í•© ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [setup, api-performance, lighthouse-performance, e2e-performance, performance-regression]
    if: always() && needs.setup.outputs.should-run-performance == 'true'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸš€ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ“¥ ëª¨ë“  ì„±ëŠ¥ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: all-reports/

      - name: ğŸ“Š ì¢…í•© ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          mkdir -p reports/performance
          node scripts/performance-report.js
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: ğŸ“¤ ìµœì¢… ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-performance-report
          path: reports/performance/comprehensive-report.html
          retention-days: 90

      - name: ğŸ’¬ PR ì½”ë©˜íŠ¸ (ì¢…í•© ê²°ê³¼)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              let comment = `## ğŸ“Š ì¢…í•© ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            
            **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì •ë³´:**
            - ì»¤ë°‹: \`${{ github.sha }}\`
            - ë¸Œëœì¹˜: \`${{ github.ref_name }}\`
            - í…ŒìŠ¤íŠ¸ ìœ í˜•: ${{ needs.setup.outputs.test-type }}
            - ê°•ë„: ${{ needs.setup.outputs.intensity }}
            
            `;
            
              // ê° í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
              const testResults = [
                { name: 'API ì„±ëŠ¥', job: 'api-performance', icon: 'ğŸ“¡' },
                { name: 'Lighthouse', job: 'lighthouse-performance', icon: 'ğŸš¦' },
                { name: 'E2E ì„±ëŠ¥', job: 'e2e-performance', icon: 'ğŸ­' },
                { name: 'íšŒê·€ ë¶„ì„', job: 'performance-regression', icon: 'ğŸ“Š' }
              ];
              
              testResults.forEach(test => {
                const status = '${{ needs.' + test.job + '.result }}';
                const statusIcon = status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'â­ï¸';
                comment += `${test.icon} ${test.name}: ${statusIcon}\\n`;
              });
            
              comment += `
            
            **ìƒì„¸ ë¦¬í¬íŠ¸:** [ì¢…í•© ì„±ëŠ¥ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            > ğŸ’¡ ì„±ëŠ¥ ìµœì í™” ê¶Œì¥ì‚¬í•­ì´ë‚˜ íšŒê·€ì‚¬í•­ì´ ë°œê²¬ë˜ë©´ ê°œë³„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('PR ì½”ë©˜íŠ¸ ì‘ì„± ì‹¤íŒ¨:', error.message);
            }

      - name: ğŸ“± ìŠ¬ë™ ì•Œë¦¼ (ì„±ëŠ¥ ì´ìŠˆ ë°œê²¬ì‹œ)
        if: failure() || (success() && github.ref == 'refs/heads/main')
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#performance-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              attachments: [{
                color: '${{ job.status }}' === 'success' ? 'good' : 'danger',
                title: 'ğŸš€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼',
                fields: [{
                  title: 'ë¸Œëœì¹˜',
                  value: '${{ github.ref_name }}',
                  short: true
                }, {
                  title: 'ì»¤ë°‹',
                  value: '${{ github.sha }}',
                  short: true
                }, {
                  title: 'ê²°ê³¼',
                  value: '${{ job.status }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨ ë˜ëŠ” ì„±ëŠ¥ íšŒê·€ ê°ì§€',
                  short: false
                }],
                actions: [{
                  type: 'button',
                  text: 'ìƒì„¸ ë³´ê¸°',
                  url: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
                }]
              }]
            }